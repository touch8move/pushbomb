---
  - name: master
    hosts: master
    # vars:
    #   SERVER_HOME: /home/ubuntu/pushbomb
    become: true
    gather_facts: false
    
    tasks:
    - name: Clone bitbucket repo
      git:
        repo: https://github.com/touch8move/pushbomb.git
        dest: /home/ubuntu/pushbomb
        version: ansible

    - name: Build nodeserver Image
      docker_image:
        path: /home/ubuntu/pushbomb
        dockerfile: dockerfile
        name: localhost:5000/nodeserver
        push: yes
    
    - name: Docker search
      shell:  docker stack ls
      register: has_stack
    - name: find app
      shell:  docker stack rm app
      when: "'app_pushbomb' not in has_stack.stdout_lines"
    - name: Service Start
      shell: docker stack deploy --compose-file ./pushbomb/docker-push.yml app